<?xml version="1.0" encoding="utf-8"?>
<modification>
    <name>Factoring 0-0-4</name>
    <code>factoring004</code>
    <version>3.x</version>
    <author>BNPL partners</author>
    <link>http://example.com</link>

    <file path="catalog/controller/checkout/checkout.php">
        <operation>
            <search>
                <![CDATA[
                    <?php
                ]]>
            </search>
            <add position="after" action="insert" offset="0">
                <![CDATA[
                    require_once DIR_SYSTEM . 'library/factoring004/vendor/autoload.php';
                ]]>
            </add>
        </operation>
        <operation>
            <search>
                <![CDATA[
                    $data['header']
                ]]>
            </search>
            <add position="after" action="insert">
                <![CDATA[
                    if ($this->config->get('payment_factoring004_payment_gateway_type') === 'modal') {
                        $data['factoring004PaymentWidgetLink'] = \BnplPartners\Factoring004Payment\ModalWidgetUrlResolver::create($this->registry)->resolve();
                    }
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/view/theme/default/template/checkout/checkout.twig">
        <operation>
            <search>
                <![CDATA[
                    {{ header }}
                ]]>
            </search>
            <add position="before" action="insert">
                <![CDATA[
                    {% if factoring004PaymentWidgetLink is defined %}
                        <script src="{{ factoring004PaymentWidgetLink }}"></script>
                    {% endif %}
                ]]>
            </add>
        </operation>
    </file>

    <file path="catalog/controller/checkout/payment_method.php">
        <operation>
            <search>
                <![CDATA[
                    $this->response->setOutput($this->load->view('checkout/payment_method', $data));
                ]]>
            </search>
            <add position="before" action="insert">
                <![CDATA[
                    if (empty($data['payment_methods']['factoring004'])) {
                        $data['factoring004Total'] = 0;
                    } elseif (isset($total)) {
                        $data['factoring004Total'] = (int) ceil($total);
                    } else {
                        $this->load->model('setting/extension');
                        $total = 0;

                        $sort_order = [];

                        $results = $this->model_setting_extension->getExtensions('total');

                        foreach ($results as $key => $value) {
                            $sort_order[$key] = $this->config->get('total_' . $value['code'] . '_sort_order');
                        }

                        array_multisort($sort_order, SORT_ASC, $results);

                        foreach ($results as $result) {
                            if ($this->config->get('total_' . $result['code'] . '_status')) {
                                $this->load->model('extension/total/' . $result['code']);

                                // We have to put the totals in an array so that they pass by reference.
                                $this->{'model_extension_total_' . $result['code']}->getTotal([
                                    'total' => &$total,
                                ]);
                            }
                        }

                        $data['factoring004Total'] = (int) ceil($total);
                    }
                ]]>
            </add>
        </operation>
    </file>
</modification>
